<div id="city-widget" class="col-lg-4 col-md-6 col-sm-12">

    <style>
        #city-widget .chart-box {
            position: relative;
            width: 100%;
            height: 440px; /* 420 yerine 440 yaptık */
            contain: content;
            isolation: isolate;
        }

        #city-widget canvas {
            display: block !important;
            width: 100% !important;
            height: 100% !important;
        }

        #city-widget .card-body {
            line-height: 1.2;
        }
    </style>

    <div class="card shadow-sm">
        <div class="card-header">
            <h2>Şehirlere Göre Siparişler</h2>
        </div>

        <div class="card-body text-center">
            <div id="cityBarInfo" class="mb-3">
                <span style="font-size:22px;font-weight:700;">@ViewBag.CityLabels[0]</span>
                <div style="font-size:15px;">
                    @{
                        var total = ((List<int>)ViewBag.CityValues).Sum();
                        var firstValue = ((List<int>)ViewBag.CityValues)[0];
                        var percent = ((double)firstValue / total * 100).ToString("0.0");
                    }
                    @percent %
                </div>
            </div>

            <div class="chart-box">
                <canvas id="cityOrdersBar"></canvas>
            </div>
        </div>

        <table class="table mt-3 mb-3">
            <thead>
                <tr><th>#</th><th>Şehir</th><th>Sipariş Sayısı</th></tr>
            </thead>
            <tbody>
                @{
                    var labels = (List<string>)ViewBag.CityLabels;
                    var values = (List<int>)ViewBag.CityValues;
                    for (int i = 0; i < labels.Count; i++)
                    {
                        <tr>
                            <td>@(i + 1)</td>
                            <td>@labels[i]</td>
                            <td>@values[i]</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (() => {
            const labels = @Html.Raw(Json.Serialize(ViewBag.CityLabels));
            const values = @Html.Raw(Json.Serialize(ViewBag.CityValues));
            const colors = ['#1F77B4','#FF7F0E','#2CA02C','#9467BD','#D62728','#17BECF','#FFC300'];
            const total = values.reduce((a,b)=>a+b,0);

            const canvas = document.querySelector('#city-widget #cityOrdersBar');
            const info   = document.querySelector('#city-widget #cityBarInfo');

            const chart = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderRadius: 8,
                        borderWidth: 1,
                        borderColor: '#fff',
                        barThickness: 30
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    layout: {
                        padding: { bottom: 30 } // 🔥 eksen değerleri için boşluk
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const v = ctx.raw, p = ((v/total)*100).toFixed(1)+'%';
                                    return `${ctx.label}: ${v} (${p})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid:{color:'#eee'},
                            ticks: { font:{ size:13 }, color:'#333' }
                        },
                        y: {
                            grid:{display:false},
                            ticks:{ font:{ weight:'600', size:13 }, color:'#222' }
                        }
                    }
                }
            });

            const setInfo = (i)=> info.innerHTML =
                `<span style="font-size:22px;font-weight:700;">${labels[i]}</span>
                 <div style="font-size:15px;">${((values[i]/total)*100).toFixed(1)}%</div>`;
            setInfo(0);

            canvas.addEventListener('mousemove', (e)=>{
                const pts = chart.getElementsAtEventForMode(e,'nearest',{intersect:true}, false);
                if (pts.length) setInfo(pts[0].index);
            });
            canvas.addEventListener('mouseleave', ()=> setInfo(0));

            const ro = new ResizeObserver(()=> chart.resize());
            ro.observe(document.querySelector('#city-widget .chart-box'));
        })();
    </script>
</div>
